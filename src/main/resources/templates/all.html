<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Add user page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<nav class="navbar" style="background-color: #2f2f2f;">
    <h4 class="navbar-brand" style="color: #9d9d9d">BootStrap</h4>
    <a class="nav-link form-inline" th:href="@{/logout}" style="color: #9d9d9d;">Logout</a>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-2 p-0" style="background-color: #f5f5f5; height: 100vh;">
            <div class="nav flex-column nav-pills" aria-orientation="vertical">
                <a class="nav-link active" id="adminTab" data-toggle="pill" href="#admin" role="tab"
                   aria-controls="admin">Admin</a>
                <a class="nav-link" id="userTab" data-toggle="pill" href="#user" role="tab"
                   aria-controls="user">User</a>
            </div>
        </div>
        <div class="col-10 p-0" style="background-color: #eeeeee">
            <div class="tab-content m-5">
                <div class="tab-pane show active" id="admin" role="tabpanel" aria-labelledby="adminTab">
                    <h2>Admin panel</h2>
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="all" href="#allUsers" data-toggle="pill" role="tab"
                               aria-controls="allUsers">Users</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="new" href="#addUser" data-toggle="pill" role="tab"
                               aria-controls="addUser">New User</a>
                        </li>
                    </ul>
                    <div class="tab-content border" style="background-color: white">
                        <div class="tab-pane show active" id="allUsers" role="tabpanel" aria-labelledby="all">
                            <h4 class="pl-3 p-1 m-0 border" style="background-color: #eeeeee">All Users</h4>
                            <table class="table table-striped p-2 m-0">
                                <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Login</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Surname</th>
                                    <th scope="col">Age</th>
                                 </tr>
                                </thead>
                                <tbody id="all_users">
                                <!--Modal window Edit user-->
                                    <div class="modal fade" id="edit">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h2 class="modal-title">Edit user</h2>
                                                    <button class="close" data-dismiss="modal">&times</button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="edit_user">
                                                        <div id="get_user"></div>
                                                    </form>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="rounded-lg" type="submit" form="edit_user"
                                                            style="color: #fffffc; background-color: #2d6ca2">Edit</button>
                                                    <button class="rounded-lg" type="submit" data-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <!--End of modal window -->
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane flex-column" id="addUser" role="tabpanel" aria-labelledby="new">
                            <div class="row justify-content-center">
                                <form class="col-4 text-center m-3" id="add_user_form" action="/admin/addUser">
                                    <div class="form-group">
                                        <label class="font-weight-bold">Login</label>
                                        <input class="form-control" style="align-self: center" type="text" name="login"
                                               placeholder="Login" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">Password</label>
                                        <input class="form-control" type="text" name="password" placeholder="Password"
                                               required>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">Name</label>
                                        <input class="form-control" type="text" name="name" placeholder="Name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">Surname</label>
                                        <input class="form-control" type="text" name="surname" placeholder="Surname"
                                               required>
                                    </div>
                                    <div class="form-group">
                                        <label class="font-weight-bold">Age</label>
                                        <input class="form-control" type="number" name="age" required>
                                    </div>
                                    <button class="rounded-lg" type="submit"
                                            style="color: #fffffc; background-color: #459c45">Add new user
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" role="tabpanel" id="user" aria-labelledby="userTab">
                    <p th:utext="${#session.getAttribute('greeting')}"></p>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/2.9.0/jquery.serializejson.min.js" type="text/javascript"></script>
<script>
    $(document).ready(function() {
        showUsers();
    });

    function showUsers() {
        $.ajax({
            url : "/admin/allUsers",
            type : "GET",
            contentType: 'application/json',
            dataType : 'json',
            success : function(users) {
                let user_data = '';
                $.each(users, function (key, value) {
                    user_data += '<tr>';
                    user_data += '<td>' + value.id + '</td>';
                    user_data += '<td>' + value.login + '</td>';
                    user_data += '<td>' + value.name + '</td>';
                    user_data += '<td>' + value.surname + '</td>';
                    user_data += '<td>' + value.age + '</td>';
                    user_data += '<td class="text-center">' +
                        '<button class="update_btn" id="' + value.id + '" data-toggle="modal" data-target="#edit">Edit</button>' +
                        '</td>';
                    user_data += '<td class="text-center">' +
                        '<button class="delete_btn" id="' + value.id + '">Delete</button>' +
                        '</td>';
                    user_data += '</tr>';
                });
                $("#all_users").html(user_data);
            }
        })
    }

    $(function () {
        $('#add_user_form').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: $(this).attr('action'),
                type : 'POST',
                data : JSON.stringify($(this).serializeJSON()),
                contentType: 'application/json',
                dataType : 'json',
                success(user) {
                    showUsers();
                    alert("User " + user.name + " " + user.surname + " created");
                }
            });
            return false;
        });
    });

    $(function () {
        $(document).on('click', '.update_btn', function () {
            let user_id = $(this).attr('id');
            $.get(
                'admin/edit',
                {id: user_id},
                function (user) {
                    let user_data = '';
                    user_data += '<fieldset disabled>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Login</label>';
                    user_data += '<input class="form-control" type="text" id="id" name="id" value="' + user.id + '" required>';
                    user_data += '</div>\n' +
                        '    </fieldset>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Login</label>';
                    user_data += '<input class="form-control" type="text" id="login" name="login" value="'+ user.login +'" required>';
                    user_data += '</div>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Password</label>\n' +
                        '        <input class="form-control" type="text" id="password" name="password"\n' +
                        '    required>\n' +
                        '    </div>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Name</label>';
                    user_data += '<input class="form-control" type="text" id="name" name="name" value="'+ user.name +'" required>';
                    user_data += ' </div>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Surname</label>';
                    user_data += '<input class="form-control" type="text" id="surname" name="surname" value="'+ user.surname +'" required>';
                    user_data += '</div>\n' +
                        '    <div class="form-group">\n' +
                        '        <label>Age</label>';
                    user_data += '<input class="form-control" type="number" id="age" name="age" value="'+ user.age +'" required>';
                    user_data += '</div>';
                    $("#get_user").html(user_data);
            });
        });
    });

    $(function () {
        $('#edit_user').submit( function (e) {
            e.preventDefault();
            $.ajax({
                url : 'admin/edit',
                type : 'PUT',
                data : JSON.stringify({
                    id: $('#id').val(),
                    login: $('#login').val(),
                    password: $('#password').val(),
                    name: $('#name').val(),
                    surname: $('#surname').val(),
                    age: $('#age').val()
                }),
                contentType : 'application/json',
                dataType : 'json',
                success(user) {
                    alert("User " + user.name + " " + user.surname + "edited");
                    showUsers();
                },
            });
        });
    });

    $(function () {
        $(document).on('click', '.delete_btn', function () {
            let user_id = $(this).attr('id');
            $.ajax({
                url : 'admin/delete',
                type : 'DELETE',
                data : JSON.stringify(user_id),
                contentType : 'application/json',
                success : function () {
                    showUsers();
                }
            });
        });
    });
</script>
</body>
</html>
